---
# Safe Photo Consolidation - Ansible Orchestration
# Copy first, process copies later - maximum safety approach
#
# Run phases step by step:
#   --tags phase0   Check drives mounted, verify disk space
#   --tags phase1   Install packages, deploy Python scripts, create venv
#   --tags phase2   Copy all media files (long-running)
#   --tags phase3   Analyze duplicates
#   --tags phase4   Deploy Nextcloud for verification
#   --tags phase5   Human verification pause
#   --tags phase6   Final consolidation (requires dry_run: false)
#   --tags phase7   Status report and completion
- name: Safe Photo Consolidation - Copy First, Process Later
  hosts: homelab
  gather_facts: yes
  vars:
    # Configuration from central config
    homelab_config: "{{ lookup('file', playbook_dir + '/../../config.yml') | from_yaml }}"
    photo_config: "{{ homelab_config.photo_consolidation }}"
    infra_config: "{{ homelab_config.infrastructure }}"

    # Derived variables
    data_root: "{{ infra_config.storage.consolidation_root }}"
    source_drives: "{{ infra_config.storage.source_drives }}"
    script_dir: "{{ playbook_dir }}/../../scripts"
    incoming_dir: "{{ data_root }}/incoming"

    # Python deployment
    python_deploy_dir: "/opt/photo-consolidator"
    python_venv_dir: "{{ python_deploy_dir }}/venv"
    python_bin: "{{ python_venv_dir }}/bin/python"
    consolidate_cmd: "{{ python_bin }} {{ python_deploy_dir }}/consolidate.py --config {{ python_deploy_dir }}/config.yml"

  tasks:
    # ==========================================
    # PHASE 0: PREREQUISITES & SAFETY VALIDATION
    # ==========================================
    - name: Phase 0 - Prerequisites and Safety Validation
      block:
        - name: "[Phase 0] Checking sudo permissions..."
          become: yes
          command: whoami
          register: sudo_check
          changed_when: false

        - name: "[Phase 0] Checking source drives are mounted..."
          stat:
            path: "{{ item.path }}"
          register: drive_check
          loop: "{{ source_drives }}"

        - name: Fail if source drives are not mounted
          fail:
            msg: >-
              Source drive {{ item.item.path }} ({{ item.item.label }}) is not mounted.
              Mount your NTFS drives read-only before running this playbook.
              See docs/05-photo-consolidation.md "Mounting Source Drives" section.
              Example: sudo mount -t ntfs-3g -o ro,noexec /dev/sdX1 {{ item.item.path }}
          when: not item.stat.exists or not item.stat.isdir
          loop: "{{ drive_check.results }}"
          loop_control:
            label: "{{ item.item.path }}"

        - name: "[Phase 0] All source drives found"
          debug:
            msg: "{{ source_drives | map(attribute='path') | list | join(', ') }}"

        - name: "[Phase 0] Checking disk space..."
          shell: |
            source_bytes=0
            {% for drive in source_drives %}
            used=$(df -B1 "{{ drive.path }}" | awk 'NR==2 {print $3}')
            source_bytes=$((source_bytes + used))
            echo "Source {{ drive.path }} ({{ drive.label }}): $(numfmt --to=iec $used)"
            {% endfor %}

            target_avail=$(df -B1 {{ data_root }} | awk 'NR==2 {print $4}')
            buffer_bytes=$(( {{ photo_config.safety.min_free_space_gb }} * 1024 * 1024 * 1024 ))
            needed=$((source_bytes + buffer_bytes))

            echo "---"
            echo "Total source: $(numfmt --to=iec $source_bytes)"
            echo "Safety buffer: {{ photo_config.safety.min_free_space_gb }}GB"
            echo "Needed: $(numfmt --to=iec $needed)"
            echo "Available on {{ data_root }}: $(numfmt --to=iec $target_avail)"

            if [ $needed -gt $target_avail ]; then
              echo "RESULT: INSUFFICIENT SPACE"
              exit 1
            fi
            echo "RESULT: OK"
          register: space_validation
          changed_when: false

        - name: "[Phase 0] Space validation results"
          debug:
            msg: "{{ space_validation.stdout_lines }}"

        - name: "[Phase 0] Prerequisites OK - ready to proceed"
          debug:
            msg: "All checks passed. Run --tags phase1 to install packages and deploy Python scripts."

      tags: [prerequisites, safety, phase0]

    # ==========================================
    # PHASE 1: SYSTEM PREPARATION & PYTHON DEPLOY
    # ==========================================
    - name: Phase 1 - System Preparation and Python Deployment
      block:
        - name: "[Phase 1] Installing required system packages..."
          apt:
            name:
              - rsync
              - pv
              - parallel
              - exiftool
              - imagemagick
              - ffmpeg
              - yq
              - tree
              - python3-venv
              - python3-dev
              - build-essential
            state: present
            update_cache: yes
          become: yes

        - name: "[Phase 1] Fixing ownership of {{ data_root }}..."
          file:
            path: "{{ data_root }}"
            state: directory
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            recurse: yes
          become: yes

        - name: "[Phase 1] Creating directory structure on {{ data_root }}..."
          file:
            path: "{{ data_root }}/{{ item }}"
            state: directory
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0755'
          become: yes
          loop:
            - incoming
            - manifests
            - duplicates/groups
            - duplicates/reports
            - final
            - logs

        - name: "[Phase 1] Creating Python deployment directory..."
          file:
            path: "{{ python_deploy_dir }}"
            state: directory
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0755'
          become: yes

        - name: "[Phase 1] Deploying Python consolidation scripts..."
          synchronize:
            src: "{{ script_dir }}/media/"
            dest: "{{ python_deploy_dir }}/"
            delete: yes
            rsync_opts:
              - "--exclude=__pycache__"
              - "--exclude=*.pyc"
              - "--exclude=.git"

        - name: "[Phase 1] Deploying config.yml..."
          copy:
            src: "{{ playbook_dir }}/../../config.yml"
            dest: "{{ python_deploy_dir }}/config.yml"
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0644'

        - name: "[Phase 1] Creating Python virtual environment..."
          command: python3 -m venv {{ python_venv_dir }}
          args:
            creates: "{{ python_venv_dir }}/bin/python"

        - name: "[Phase 1] Installing Python dependencies in venv..."
          command: "{{ python_venv_dir }}/bin/pip install -r {{ python_deploy_dir }}/requirements.txt"
          register: pip_install
          changed_when: "'Successfully installed' in pip_install.stdout"

        - name: "[Phase 1] Verifying Python CLI loads correctly..."
          command: "{{ consolidate_cmd }} --help"
          register: cli_check
          changed_when: false

        - name: "[Phase 1] Configuration summary"
          debug:
            msg:
              - "Data root: {{ data_root }}"
              - "Incoming dir: {{ incoming_dir }}"
              - "Python deploy dir: {{ python_deploy_dir }}"
              - "Source drives: {{ source_drives | length }}"
              - "Dry run: {{ photo_config.process.dry_run }}"
              - "Parallel jobs: {{ photo_config.process.parallel_jobs }}"
              - "Min free space: {{ photo_config.safety.min_free_space_gb }}GB"

        - name: "[Phase 1] System preparation complete"
          debug:
            msg: "Packages installed, Python deployed. Run --tags phase2 to start copying files."

      tags: [setup, install, phase1]

    # ==========================================
    # PHASE 2: SAFE COPY OPERATION
    # ==========================================
    - name: Phase 2 - Safe Copy All Media Files
      block:
        - name: "[Phase 2] Copying media files from all source drives (this may take hours)..."
          command: "{{ consolidate_cmd }} copy --no-dry-run --progress"
          register: copy_result
          async: 14400  # 4 hours timeout for large copy operations
          poll: 60      # Check every minute

        - name: "[Phase 2] Copy output (last 30 lines)"
          debug:
            msg: "{{ copy_result.stdout_lines[-30:] | default(['No output']) }}"

        - name: "[Phase 2] Counting copied files in {{ incoming_dir }}..."
          find:
            paths: "{{ incoming_dir }}"
            file_type: file
            recurse: yes
          register: copied_files

        - name: Fail if no files were copied
          fail:
            msg: "No files were copied to {{ incoming_dir }}. Check copy operation logs."
          when: copied_files.files | length == 0

        - name: "[Phase 2] Checking copied data size..."
          shell: du -sh {{ incoming_dir }}
          register: incoming_size
          changed_when: false

        - name: "[Phase 2] Copy complete"
          debug:
            msg:
              - "{{ copied_files.files | length }} files copied"
              - "Size: {{ incoming_size.stdout }}"
              - "Location: {{ incoming_dir }}"
              - "Original drives are safe to disconnect."
              - "Run --tags phase3 to analyze duplicates."

      tags: [copy, safe_copy, phase2]

    # ==========================================
    # PHASE 3: ANALYZE COPIED FILES ONLY
    # ==========================================
    - name: Phase 3 - Duplicate Analysis on Copied Files Only
      block:
        - name: "[Phase 3] Checking incoming directory..."
          find:
            paths: "{{ incoming_dir }}"
            file_type: file
            recurse: yes
          register: incoming_files_check

        - name: Fail if no files found in incoming directory
          fail:
            msg: >-
              No files found in {{ incoming_dir }}.
              Run Phase 2 (copy) first: --tags phase2
          when: incoming_files_check.files | length == 0

        - name: "[Phase 3] Found {{ incoming_files_check.files | length }} files to analyze"
          debug:
            msg: "Starting duplicate analysis..."

        - name: "[Phase 3] Running duplicate analysis (this may take up to 1 hour)..."
          command: "{{ consolidate_cmd }} analyze"
          register: analysis_result
          async: 3600  # 1 hour timeout
          poll: 30

        - name: "[Phase 3] Analysis output (last 20 lines)"
          debug:
            msg: "{{ analysis_result.stdout_lines[-20:] | default(['No output']) }}"

        - name: "[Phase 3] Counting duplicate groups..."
          find:
            paths: "{{ data_root }}/duplicates/groups"
            patterns: "group_*.txt"
          register: duplicate_groups

        - name: "[Phase 3] Reading analysis report..."
          shell: |
            if [ -f "{{ data_root }}/duplicates/reports/copied_files_analysis.txt" ]; then
              echo "=== DUPLICATE ANALYSIS RESULTS ==="
              head -30 "{{ data_root }}/duplicates/reports/copied_files_analysis.txt"
            else
              echo "No duplicate analysis report found"
            fi
          register: duplicate_summary
          changed_when: false

        - name: "[Phase 3] Analysis summary"
          debug:
            msg: "{{ duplicate_summary.stdout_lines }}"

        - name: "[Phase 3] Analysis complete"
          debug:
            msg:
              - "{{ duplicate_groups.files | length }} duplicate groups found"
              - "Reports: {{ data_root }}/duplicates/reports/"
              - "Run --tags phase4 to deploy Nextcloud for visual verification."

      tags: [analysis, duplicates, phase3]

    # ==========================================
    # PHASE 4: NEXTCLOUD VERIFICATION SETUP
    # ==========================================
    - name: Phase 4 - Deploy Nextcloud for Human Verification
      block:
        - name: "[Phase 4] Deploying Nextcloud verification setup..."
          copy:
            src: "{{ script_dir }}/setup/setup_nextcloud_verification.sh"
            dest: "/tmp/setup_nextcloud_verification.sh"
            mode: '0755'

        - name: "[Phase 4] Running Nextcloud setup..."
          shell: |
            export HOMELAB_ROOT="{{ playbook_dir }}/../.."
            /tmp/setup_nextcloud_verification.sh
          register: nextcloud_setup
          environment:
            PATH: "{{ ansible_env.PATH }}"

        - name: "[Phase 4] Nextcloud setup output"
          debug:
            msg: "{{ nextcloud_setup.stdout_lines[-30:] | default(['Setup in progress']) }}"

        - name: "[Phase 4] Waiting for Nextcloud to become available..."
          uri:
            url: "http://localhost:8080"
            method: GET
          register: nextcloud_ready
          until: nextcloud_ready.status == 200
          retries: 30
          delay: 10
          ignore_errors: yes

        - name: "[Phase 4] Nextcloud ready"
          debug:
            msg:
              - "Access: http://{{ ansible_default_ipv4.address }}:8080"
              - "Navigate to Files > verification"
              - "Review: incoming/ (your photos) and duplicates/ (analysis)"
              - "Run --tags phase5,phase6 when ready to consolidate."

      tags: [verification, nextcloud, phase4]

    # ==========================================
    # PHASE 5: HUMAN VERIFICATION PAUSE
    # ==========================================
    - name: Phase 5 - Human Verification Checkpoint
      block:
        - name: "[Phase 5] Waiting for human verification..."
          pause:
            prompt: |

              ====================================================
              HUMAN VERIFICATION REQUIRED
              ====================================================

              All photos safely copied to {{ incoming_dir }}
              Duplicate analysis completed
              Nextcloud verification interface ready

              VERIFICATION STEPS:
              1. Browse to: http://{{ ansible_default_ipv4.address }}:8080
              2. Login with the credentials shown above
              3. Go to Files > verification
              4. Review your photos in incoming/
              5. Check duplicate analysis in duplicates/reports/
              6. Spot-check some duplicate groups

              SAFETY REMINDER:
              - Your original drives are COMPLETELY UNTOUCHED
              - You are reviewing COPIES in {{ incoming_dir }}
              - Original drives can be disconnected safely

              Take your time to verify everything looks correct.

              Press ENTER when ready to proceed with final consolidation,
              or Ctrl+C to abort and keep everything as-is.
              ====================================================
          when: not (photo_config.process.dry_run | default(true) | bool)

        - name: "[Phase 5] Skipped - dry_run is enabled"
          debug:
            msg: "Set dry_run: false in config.yml to enable verification pause and consolidation."
          when: photo_config.process.dry_run | default(true) | bool

      tags: [verification, pause, phase5]

    # ==========================================
    # PHASE 6: FINAL CONSOLIDATION (OPTIONAL)
    # ==========================================
    - name: Phase 6 - Final Consolidation of Copied Files
      block:
        - name: "[Phase 6] Checking for duplicate analysis results..."
          find:
            paths: "{{ data_root }}/duplicates/groups"
            patterns: "group_*.txt"
          register: duplicate_groups_check

        - name: Fail if no duplicate analysis found
          fail:
            msg: >-
              No duplicate analysis found in {{ data_root }}/duplicates/groups/.
              Run Phase 3 (analysis) first: --tags phase3
          when: duplicate_groups_check.files | length == 0

        - name: "[Phase 6] Found {{ duplicate_groups_check.files | length }} duplicate groups to process"
          debug:
            msg: "Starting consolidation..."
          when: not (photo_config.process.dry_run | default(true) | bool)

        - name: "[Phase 6] Running final consolidation..."
          command: "{{ consolidate_cmd }} consolidate --no-dry-run"
          register: consolidation_result
          when: not (photo_config.process.dry_run | default(true) | bool)

        - name: "[Phase 6] Skipped - dry_run is enabled"
          debug:
            msg: "Set dry_run: false in config.yml to run the actual consolidation."
          when: photo_config.process.dry_run | default(true) | bool

        - name: "[Phase 6] Consolidation output"
          debug:
            msg: "{{ consolidation_result.stdout_lines[-20:] | default(['Skipped - dry run mode']) }}"

        - name: "[Phase 6] Generating summary..."
          shell: |
            final_count=$(find {{ data_root }}/final -type f 2>/dev/null | wc -l || echo 0)
            final_size=$(du -sh {{ data_root }}/final 2>/dev/null | awk '{print $1}' || echo "0B")
            incoming_count=$(find {{ incoming_dir }} -type f 2>/dev/null | wc -l || echo 0)
            incoming_size=$(du -sh {{ incoming_dir }} 2>/dev/null | awk '{print $1}' || echo "0B")

            echo "=== CONSOLIDATION SUMMARY ==="
            echo "Incoming: $incoming_count files ($incoming_size)"
            echo "Final:    $final_count files ($final_size)"
            if [ "$incoming_count" -gt 0 ] && [ "$final_count" -gt 0 ]; then
              saved=$((incoming_count - final_count))
              echo "Removed:  $saved duplicate files"
            fi
            echo "Location: {{ data_root }}/final/"
            echo "Original drives: safe and untouched"
          register: final_summary
          changed_when: false

        - name: "[Phase 6] Results"
          debug:
            msg: "{{ final_summary.stdout_lines }}"

      tags: [consolidation, final, phase6]

    # ==========================================
    # PHASE 7: STATUS & COMPLETION
    # ==========================================
    - name: Phase 7 - Status and Completion
      block:
        - name: "[Phase 7] Running status check..."
          command: "{{ consolidate_cmd }} status"
          register: status_result
          changed_when: false

        - name: "[Phase 7] Current status"
          debug:
            msg: "{{ status_result.stdout_lines }}"

        - name: "[Phase 7] Generating completion report..."
          shell: |
            report_file="{{ data_root }}/logs/consolidation_report_$(date +%Y%m%d_%H%M%S).txt"

            cat > "$report_file" << EOL
            === PHOTO CONSOLIDATION REPORT ===
            Completed: $(date)
            Server: {{ inventory_hostname }}

            Source drives: {{ source_drives | length }}
            {% for drive in source_drives %}
            - {{ drive.path }} ({{ drive.label }})
            {% endfor %}

            Files copied: $(find {{ incoming_dir }} -type f 2>/dev/null | wc -l)
            Duplicate groups: $(find {{ data_root }}/duplicates/groups -name "group_*.txt" 2>/dev/null | wc -l)
            Final collection: $(find {{ data_root }}/final -type f 2>/dev/null | wc -l) files

            Original drives: NEVER MODIFIED
            EOL

            echo "Report saved: $report_file"
            cat "$report_file"
          register: completion_report
          changed_when: false

        - name: "[Phase 7] Completion report"
          debug:
            msg: "{{ completion_report.stdout_lines }}"

        - name: "[Phase 7] Cleaning up temporary files..."
          file:
            path: "/tmp/setup_nextcloud_verification.sh"
            state: absent

        - name: "[Phase 7] Done"
          debug:
            msg: "Consolidation workflow complete. Python scripts deployed at {{ python_deploy_dir }}."

      tags: [cleanup, completion, phase7]
      always:
        - name: Ensure cleanup runs even on failure
          file:
            path: "/tmp/setup_nextcloud_verification.sh"
            state: absent
          ignore_errors: yes
