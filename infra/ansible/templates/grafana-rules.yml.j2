# ==============================================================================
# Grafana Alerting Provisioning - Alert Rules
# ==============================================================================
# Auto-generated by Ansible - DO NOT EDIT MANUALLY
# ==============================================================================

apiVersion: 1

groups:
  - orgId: 1
    name: homelab-alerts
    folder: Homelab
    interval: 30s
    rules:
      # ====================
      # DISK SPACE ALERT
      # ====================
      - uid: disk-space-alert
        title: Low Disk Space
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: influxdb-homelab
            model:
              query: |
                from(bucket: "{{ monitoring.influxdb.bucket }}")
                  |> range(start: -10m)
                  |> filter(fn: (r) => r["_measurement"] == "disk")
                  |> filter(fn: (r) => r["_field"] == "free")
                  |> filter(fn: (r) => r["path"] == "/data")
                  |> last()
                  |> map(fn: (r) => ({ r with _value: float(v: r._value) / 1073741824.0 }))
                  |> keep(columns: ["_value", "_time"])
          - refId: C
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - {{ monitoring.alerts.disk_space_threshold_gb }}
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
        noDataState: OK
        execErrState: OK
        for: 5m
        annotations:
          summary: "Disk space is running low on /data partition"
          description: "Available disk space on /data is below {{ monitoring.alerts.disk_space_threshold_gb }}GB"
        labels:
          severity: warning
        isPaused: false

      # ====================
      # MEMORY USAGE ALERT
      # ====================
      - uid: memory-usage-alert
        title: High Memory Usage
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: influxdb-homelab
            model:
              query: |
                from(bucket: "{{ monitoring.influxdb.bucket }}")
                  |> range(start: -10m)
                  |> filter(fn: (r) => r["_measurement"] == "mem")
                  |> filter(fn: (r) => r["_field"] == "used_percent")
                  |> last()
                  |> keep(columns: ["_value", "_time"])
          - refId: C
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - {{ monitoring.alerts.memory_threshold_percent }}
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
        noDataState: OK
        execErrState: OK
        for: 10m
        annotations:
          summary: "Memory usage is critically high"
          description: "Memory usage has been above {{ monitoring.alerts.memory_threshold_percent }}% for 10 minutes"
        labels:
          severity: critical
        isPaused: false

      # ====================
      # CPU USAGE ALERT
      # ====================
      - uid: cpu-usage-alert
        title: High CPU Usage
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: influxdb-homelab
            model:
              query: |
                from(bucket: "{{ monitoring.influxdb.bucket }}")
                  |> range(start: -10m)
                  |> filter(fn: (r) => r["_measurement"] == "cpu")
                  |> filter(fn: (r) => r["_field"] == "usage_idle")
                  |> filter(fn: (r) => r["cpu"] == "cpu-total")
                  |> last()
                  |> map(fn: (r) => ({ r with _value: 100.0 - r._value }))
                  |> keep(columns: ["_value", "_time"])
          - refId: C
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - {{ monitoring.alerts.cpu_threshold_percent }}
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
        noDataState: OK
        execErrState: OK
        for: 15m
        annotations:
          summary: "CPU usage is critically high"
          description: "CPU usage has been above {{ monitoring.alerts.cpu_threshold_percent }}% for 15 minutes"
        labels:
          severity: warning
        isPaused: false

      # ====================
      # CONTAINER UNHEALTHY ALERT
      # ====================
      - uid: container-unhealthy-alert
        title: Container Unhealthy
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: influxdb-homelab
            model:
              query: |
                from(bucket: "{{ monitoring.influxdb.bucket }}")
                  |> range(start: -5m)
                  |> filter(fn: (r) => r["_measurement"] == "docker_container_health")
                  |> filter(fn: (r) => r["_field"] == "health_status")
                  |> filter(fn: (r) => r["_value"] != "healthy")
                  |> group(columns: ["container_name"])
                  |> count()
                  |> keep(columns: ["_value", "container_name"])
                  |> toFloat()
          - refId: C
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
        noDataState: OK
        execErrState: OK
        for: 5m
        annotations:
          summary: "Container is reporting unhealthy status"
          description: "Container has been unhealthy for more than 5 minutes"
        labels:
          severity: warning
        isPaused: false

      # ====================
      # CONTAINER RESTART ALERT
      # ====================
      - uid: container-restart
        title: Container Restarted
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: influxdb-homelab
            model:
              query: |
                from(bucket: "{{ monitoring.influxdb.bucket }}")
                  |> range(start: -5m)
                  |> filter(fn: (r) => r["_measurement"] == "docker_container_status")
                  |> filter(fn: (r) => r["_field"] == "uptime_ns")
                  |> filter(fn: (r) => r._value < 180000000000)
                  |> group(columns: ["container_name"])
                  |> count()
                  |> keep(columns: ["_value", "container_name"])
                  |> toFloat()
          - refId: C
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
        noDataState: OK
        execErrState: OK
        for: 0s
        annotations:
          summary: "Container restarted"
          description: "A container has uptime under 3 minutes (recently restarted)"
        labels:
          severity: warning
        isPaused: false
