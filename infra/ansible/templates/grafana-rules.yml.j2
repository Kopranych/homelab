# ==============================================================================
# Grafana Alerting Provisioning - Alert Rules
# ==============================================================================
# Auto-generated by Ansible - DO NOT EDIT MANUALLY
# ==============================================================================

apiVersion: 1

groups:
  - orgId: 1
    name: homelab-alerts
    folder: Homelab
    interval: 1m
    rules:
      # ====================
      # DISK SPACE ALERT
      # ====================
      - uid: disk-space-alert
        title: Low Disk Space
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: influxdb-homelab
            model:
              query: |
                from(bucket: "{{ monitoring.influxdb.bucket }}")
                  |> range(start: -10m)
                  |> filter(fn: (r) => r["_measurement"] == "disk")
                  |> filter(fn: (r) => r["_field"] == "used_percent")
                  |> filter(fn: (r) => r["path"] == "/data")
                  |> aggregateWindow(every: 1m, fn: mean)
          - refId: C
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - {{ (100 - (monitoring.alerts.disk_space_threshold_gb / 9.11)) | int }}
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "Disk space is running low on /data partition"
          description: "Available disk space on /data is below {{ monitoring.alerts.disk_space_threshold_gb }}GB"
        labels:
          severity: warning
        isPaused: false

      # ====================
      # MEMORY USAGE ALERT
      # ====================
      - uid: memory-usage-alert
        title: High Memory Usage
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: influxdb-homelab
            model:
              query: |
                from(bucket: "{{ monitoring.influxdb.bucket }}")
                  |> range(start: -10m)
                  |> filter(fn: (r) => r["_measurement"] == "mem")
                  |> filter(fn: (r) => r["_field"] == "used_percent")
                  |> aggregateWindow(every: 1m, fn: mean)
          - refId: C
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - {{ monitoring.alerts.memory_threshold_percent }}
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 10m
        annotations:
          summary: "Memory usage is critically high"
          description: "Memory usage has been above {{ monitoring.alerts.memory_threshold_percent }}% for 10 minutes"
        labels:
          severity: critical
        isPaused: false

      # ====================
      # CPU USAGE ALERT
      # ====================
      - uid: cpu-usage-alert
        title: High CPU Usage
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: influxdb-homelab
            model:
              query: |
                from(bucket: "{{ monitoring.influxdb.bucket }}")
                  |> range(start: -10m)
                  |> filter(fn: (r) => r["_measurement"] == "cpu")
                  |> filter(fn: (r) => r["_field"] == "usage_idle")
                  |> filter(fn: (r) => r["cpu"] == "cpu-total")
                  |> map(fn: (r) => ({ r with _value: 100.0 - r._value }))
                  |> aggregateWindow(every: 1m, fn: mean)
          - refId: C
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - {{ monitoring.alerts.cpu_threshold_percent }}
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 15m
        annotations:
          summary: "CPU usage is critically high"
          description: "CPU usage has been above {{ monitoring.alerts.cpu_threshold_percent }}% for 15 minutes"
        labels:
          severity: warning
        isPaused: false

      # ====================
      # CONTAINER RESTART ALERT
      # ====================
      - uid: container-restart-alert
        title: Container Restarts Detected
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 3600
              to: 0
            datasourceUid: influxdb-homelab
            model:
              query: |
                from(bucket: "{{ monitoring.influxdb.bucket }}")
                  |> range(start: -1h)
                  |> filter(fn: (r) => r["_measurement"] == "docker_container_status")
                  |> filter(fn: (r) => r["_field"] == "exitcode")
                  |> filter(fn: (r) => r._value != 0)
                  |> count()
          - refId: C
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - {{ monitoring.alerts.container_restart_threshold }}
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "Container has restarted multiple times"
          description: "A container has restarted more than {{ monitoring.alerts.container_restart_threshold }} times in the last hour"
        labels:
          severity: warning
        isPaused: false
