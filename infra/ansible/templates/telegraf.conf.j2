# ==============================================================================
# Telegraf Configuration for Homelab Monitoring
# ==============================================================================
# Auto-generated by Ansible - DO NOT EDIT MANUALLY
# Collects: System, Docker, Process metrics
# Outputs to: InfluxDB 2.x
# ==============================================================================

[global_tags]
  environment = "{{ ENVIRONMENT | default('production') }}"
  host = "{{ ansible_hostname }}"
  datacenter = "homelab"

[agent]
  interval = "{{ monitoring.telegraf.interval }}"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "{{ monitoring.telegraf.flush_interval }}"
  flush_jitter = "0s"
  precision = "0s"
  hostname = "{{ ansible_hostname }}"
  omit_hostname = false

# ==============================================================================
# OUTPUT PLUGINS
# ==============================================================================

[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "{{ influxdb_token }}"
  organization = "{{ monitoring.influxdb.organization }}"
  bucket = "{{ monitoring.influxdb.bucket }}"
  timeout = "5s"
  user_agent = "telegraf-homelab"

# ==============================================================================
# INPUT PLUGINS - SYSTEM METRICS
# ==============================================================================

# CPU Metrics
[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false
  report_active = true
  core_tags = false

# Memory Metrics
[[inputs.mem]]

# Disk I/O Metrics
[[inputs.diskio]]
  # Monitor all physical disks (auto-detect)
  # Excludes loop devices and device mapper by default
  skip_serial_number = false

# Disk Usage Metrics
[[inputs.disk]]
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "iso9660", "overlay", "aufs", "squashfs"]
  mount_points = ["/", "/data", "/home"]

# Network Interface Metrics
[[inputs.net]]
  # Monitor physical and VPN interfaces, exclude Docker virtual interfaces
  interfaces = ["eth*", "enp*", "ens*", "wlp*", "wlan*", "tailscale*"]
  ignore_protocol_stats = false

  # Exclude Docker bridge and veth interfaces to reduce noise
  [inputs.net.tagdrop]
    interface = ["docker*", "br-*", "veth*"]

# System Load Metrics
[[inputs.system]]

# Process Count Metrics
[[inputs.processes]]

# Kernel Metrics
[[inputs.kernel]]

# Swap Metrics
[[inputs.swap]]

# ==============================================================================
# INPUT PLUGINS - DOCKER METRICS
# ==============================================================================

# Docker Container Metrics
[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
  gather_services = false
  container_name_include = []
  container_name_exclude = []
  timeout = "5s"
  perdevice = true
  total = true
  docker_label_include = []
  docker_label_exclude = []

# ==============================================================================
# INPUT PLUGINS - PROCESS METRICS
# ==============================================================================

# Top Processes by CPU
[[inputs.procstat]]
  pattern = ".*"
  pid_finder = "native"
  fieldpass = ["cpu_usage", "memory_rss", "memory_vms"]

# ==============================================================================
# INPUT PLUGINS - NEXTCLOUD SERVICES (OPTIONAL - DISABLED BY DEFAULT)
# ==============================================================================
# NOTE: To enable Nextcloud monitoring, uncomment the inputs below AND connect
# the monitoring stack to the nextcloud network in docker-compose.yml:
#   networks:
#     - monitoring
#     - nextcloud_default
#
# PostgreSQL Metrics (Nextcloud database)
# [[inputs.postgresql]]
#   address = "host=nextcloud-db user=nextcloud password={{ nextcloud.database.password | default('changeme') }} sslmode=disable dbname=nextcloud"
#   max_lifetime = "0s"
#   databases = ["nextcloud"]
#
# Redis Metrics (Nextcloud cache)
# [[inputs.redis]]
#   servers = ["tcp://nextcloud-redis:6379"]
#   password = "{{ nextcloud.redis.password | default('') }}"

# ==============================================================================
# INPUT PLUGINS - CUSTOM METRICS
# ==============================================================================

# Photo Consolidation Metrics (OPTIONAL - uncomment when needed)
# [[inputs.exec]]
#   commands = ["{{ monitoring.data_root }}/../../../scripts/monitoring/photo_metrics.py"]
#   timeout = "30s"
#   data_format = "influx"
#   interval = "5m"

# Note: The photo_metrics.py script is available in scripts/monitoring/
# Uncomment the above section once you start using photo consolidation

# ==============================================================================
# INPUT PLUGINS - HEALTH CHECKS
# ==============================================================================

# HTTP Response Time Monitoring
[[inputs.http_response]]
  urls = [
    "http://localhost:{{ monitoring.grafana.port }}/api/health",
    "http://localhost:{{ monitoring.influxdb.port }}/health"
{% if nextcloud is defined %}
    ,"http://localhost/status.php"
{% endif %}
  ]
  response_timeout = "5s"
  method = "GET"
  follow_redirects = true

# ==============================================================================
# INPUT PLUGINS - SYSTEM SENSORS
# ==============================================================================

# Temperature Sensors (if available)
[[inputs.sensors]]
  remove_numbers = false
  timeout = "5s"

# ==============================================================================
# PROCESSOR PLUGINS
# ==============================================================================

# Add common tags to all metrics
[[processors.enum]]
  [[processors.enum.mapping]]
    tag = "status"
    [processors.enum.mapping.value_mappings]
      running = 1
      stopped = 0
      paused = 2

# ==============================================================================
# AGGREGATOR PLUGINS
# ==============================================================================

# Calculate min/max/mean over intervals
[[aggregators.basicstats]]
  period = "30s"
  drop_original = false
  stats = ["mean", "min", "max", "stdev"]
  namepass = ["cpu_usage*", "mem_used*", "disk_used*"]
