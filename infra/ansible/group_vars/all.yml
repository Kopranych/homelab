---
# Ansible Global Configuration - References Main Homelab Config
# This file loads configuration from the main config.yml

# Load main configuration
homelab_config_file: "{{ playbook_dir }}/../../config.yml"
homelab_environment: "{{ ansible_environment | default('production') }}"

# Infrastructure settings (loaded from main config)
homelab_hostname: "{{ (lookup('file', homelab_config_file) | from_yaml).infrastructure.server.hostname }}"
homelab_data_root: "{{ (lookup('file', homelab_config_file) | from_yaml).infrastructure.storage.data_root }}"

# Photo consolidation settings (loaded from main config)
photo_consolidation: "{{ (lookup('file', homelab_config_file) | from_yaml).photo_consolidation }}"

# Source drives from main config
source_drives: "{{ (lookup('file', homelab_config_file) | from_yaml).infrastructure.storage.source_drives | map(attribute='path') | list }}"

# Target location 
target_base: "{{ homelab_data_root }}"

# Media extensions from main config
media_extensions:
  photos: "{{ photo_consolidation.extensions.photos | join(',') }}"
  videos: "{{ photo_consolidation.extensions.videos | join(',') }}"

# Process control from main config
dry_run: "{{ photo_consolidation.process.dry_run }}"
preserve_structure: "{{ photo_consolidation.process.preserve_structure }}"
parallel_jobs: "{{ photo_consolidation.process.parallel_jobs }}"

# Safety settings from main config
max_duplicate_percentage: "{{ photo_consolidation.safety.max_duplicate_percentage }}"
min_free_space_gb: "{{ photo_consolidation.safety.min_free_space_gb }}"

# Services configuration
services_config: "{{ (lookup('file', homelab_config_file) | from_yaml).services }}"

# Network configuration
network_config: "{{ (lookup('file', homelab_config_file) | from_yaml).network }}"

# ====================
# MONITORING CONFIGURATION
# ====================
# Load monitoring stack configuration from main config
_monitoring_base: "{{ (lookup('file', homelab_config_file) | from_yaml).services.core.monitoring }}"

# Override values that need proper Ansible variable expansion
_monitoring_overrides:
  compose_dir: "/home/{{ ansible_user }}/docker-compose/monitoring"
  influxdb:
    admin_password: "{{ vault_influxdb_password | default('changeme_influx') }}"
  grafana:
    admin_password: "{{ vault_grafana_password | default('changeme_grafana') }}"
  telegram:
    bot_token: "{{ vault_telegram_bot_token | default(_monitoring_base.telegram.bot_token) }}"
    chat_id: "{{ vault_telegram_chat_id | default(_monitoring_base.telegram.chat_id) }}"

# Merge base config with overrides
monitoring: "{{ _monitoring_base | combine(_monitoring_overrides, recursive=True) }}"

# ====================
# NEXTCLOUD CONFIGURATION
# ====================
nextcloud:
  # Installation directories
  compose_dir: "/home/{{ ansible_user }}/docker-compose/nextcloud"
  certs_dir: "/home/{{ ansible_user }}/docker-compose/nextcloud/certs"

  # Data directories (on /data partition)
  data_root: "/data/docker/nextcloud"
  user_files: "/data/nextcloud/files"
  photo_consolidation: "/data/photo-consolidation"

  # Docker image versions
  images:
    nextcloud: "nextcloud:28-apache"
    postgres: "postgres:15-alpine"
    redis: "redis:7-alpine"
    traefik: "traefik:v2.10"

  # Database configuration
  database:
    name: "nextcloud"
    user: "nextcloud"
    password: "nextcloud_db_pass_2025"  # Change in production!

  # Redis configuration
  redis:
    password: "redis_pass_2025"  # Change in production!

  # Admin configuration
  admin:
    user: "admin"
    password: "admin_pass_2025"  # Change in production!

  # Network configuration
  network:
    # These will be auto-detected during deployment
    local_ip: "{{ ansible_default_ipv4.address | default('localhost') }}"
    tailscale_ip: ""  # Auto-detected
    tailscale_hostname: ""  # Auto-detected

  # HTTPS configuration
  https:
    enabled: true  # Set to false to skip HTTPS setup
    tailscale_cert_path: "/var/lib/tailscale/certs"

  # Trusted domains (will be populated during deployment)
  trusted_domains:
    - "localhost"
    - "192.168.0.6"
    - "homelab"
    - "homelab.nebelung-mercat.ts.net"
    - "100.65.45.18"

# Docker configuration
docker:
  # User to add to docker group
  user: "{{ ansible_user }}"

  # Docker daemon configuration
  daemon_config:
    log_driver: "json-file"
    log_opts:
      max_size: "10m"
      max_file: "3"
    storage_driver: "overlay2"

  # APT packages for Docker
  prerequisites:
    - curl
    - wget
    - apt-transport-https
    - ca-certificates
    - gnupg
    - lsb-release

  packages:
    - docker-ce
    - docker-ce-cli
    - containerd.io
    - docker-buildx-plugin
    - docker-compose-plugin